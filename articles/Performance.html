<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>R6 and Reference Class performance tests • R6</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/all.min.css" integrity="sha256-nAmazAk6vS34Xqo0BSrTb+abbtFlgsFK7NKSi6o7Y78=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.7.1/css/v4-shims.min.css" integrity="sha256-6qHlizsOWFskGlwVOKuns+D1nB6ssZrHQrNj1wGplHc=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="R6 and Reference Class performance tests">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-115082821-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-115082821-1');
</script>
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">R6</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.5.0.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Debugging.html">Debugging</a>
    </li>
    <li>
      <a href="../articles/Introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/Performance.html">R6 and Reference Class performance tests</a>
    </li>
    <li>
      <a href="../articles/Portable.html">Portable and non-portable R6 classes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/R6">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="Performance_files/header-attrs-2.10/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>R6 and Reference Class performance tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/R6/blob/master/vignettes/Performance.Rmd"><code>vignettes/Performance.Rmd</code></a></small>
      <div class="hidden name"><code>Performance.Rmd</code></div>

    </div>

    
    
<p>This document compares the memory costs and speed of R’s reference classes against R6 classes and simple environments. For most uses, R6 and reference classes have comparable features, but as we’ll see, R6 classes are faster and lighter weight.</p>
<p>This document tests reference classes against R6 classes (in many variations), as well as against very simple reference objects: environments created by function calls.</p>
<hr>
<p>First we’ll load some packages which will be used below:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">microbenchmark.unit =</span> <span class="st">"us"</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pryr)  <span class="co"># For object_size function</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span></code></pre></div>
<hr>
<div id="class-definitions" class="section level1">
<h1 class="hasAnchor">
<a href="#class-definitions" class="anchor"></a>Class definitions</h1>
<p>We’ll start by defining a number of classes or class-like entities, using reference classes, R6 classes, and simple environments that are created directly by functions. There are a number of options for R6 that can affect the size of the resulting objects, so we will use a number of variants. These classes will be used for the speed and memory tests that follow. This is a lot of boring code, so you may want to skip ahead to the results.</p>
<p>All of these classes have the same basic characteristics:</p>
<ul>
<li>A field named <code>x</code> that contains a number.</li>
<li>An way of initializing the value of <code>x</code>.</li>
<li>A method named <code>getx</code> for retrieving the value of <code>x</code>.</li>
<li>A method named <code>inc</code> for incrementing the value of <code>x</code>.</li>
</ul>
<p>The fields and methods are accessed with the <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> operator, so if we have an object named <code>obj</code>, we could use <code>obj$x</code> or <code>obj$getx()</code>.</p>
<div id="r-reference-class" class="section level2">
<h2 class="hasAnchor">
<a href="#r-reference-class" class="anchor"></a>R reference class</h2>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>RC <span class="ot">&lt;-</span> <span class="fu">setRefClass</span>(<span class="st">"RC"</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="st">"numeric"</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) .self<span class="sc">$</span>x <span class="ot">&lt;-</span> x,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() x,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>In reference classes, the binding that points back to the object is named <code>.self</code>. Within a method, assignment can be done by using <code>.self</code>, as in <code>.self$x &lt;- 10</code>, or by using <code>&lt;&lt;-</code>, as in <code>x &lt;&lt;- 10</code>.</p>
<p>To create an object, simply call <code>$new()</code> on the class:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>RC<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Reference class object of class "RC"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Field "x":</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
<div id="r6-class" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class" class="anchor"></a>R6 class</h2>
<p>Creating an R6 class is similar to the reference class, except that there’s no need to separate the fields and methods, and you can’t specify the types of the fields.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>R6 <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6"</span>,</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> x,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() self<span class="sc">$</span>x,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Whereas reference classes use <code>.self</code>, R6 classes use <code>self</code> (without the leading period). As with reference classes, objects are instantiated by calling <code>$new()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>R6<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;R6&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Public:</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     getx: function () </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     inc: function (n = 1) </span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     initialize: function (x = 1) </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     x: 1</span></span></code></pre></div>
<p>An R6 object essentially just a set of environments structured in a particular way. The fields and methods for an R6 object have bindings (that is, they have names) in the <em>public environment</em>. There is also have a separate environment which is the <em>enclosing environment</em> for methods (they “run in” an environment that contains a binding named <code>self</code>, which is simply a reference to the public environment).</p>
</div>
<div id="r6-class-without-class-attribute" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class-without-class-attribute" class="anchor"></a>R6 class, without class attribute</h2>
<p>By default, a class attribute is added to R6 objects. This attribute adds a slight performance penalty because R will attempt to use S3 dispatch when using <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> on the object.</p>
<p>It’s possible generate objects without the class attribute, by using <code>class=FALSE</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>R6NoClass <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6NoClass"</span>,</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="cn">FALSE</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> x,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() self<span class="sc">$</span>x,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> self<span class="sc">$</span>x <span class="sc">+</span> n</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Note that without the class attribute, S3 method dispatch on the objects is not possible.</p>
</div>
<div id="r6-class-non-portable" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class-non-portable" class="anchor"></a>R6 class, non-portable</h2>
<p>By default, R6 objects are <em>portable</em>. This means that inheritance can be in classes that are in different packages. However, it also requires the use of <code>self$</code> and <code>private$</code> to access members, and this incurs a small performance penalty.</p>
<p>If <code>portable=FALSE</code> is used, members can be accessed without using <code>self$</code>, and assignment can be done with <code>&lt;&lt;-</code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>R6NonPortable <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6NonPortable"</span>,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">portable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">value =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> value,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() x,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="r6-class-with-cloneablefalse" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class-with-cloneablefalse" class="anchor"></a>R6 class, with <code>cloneable=FALSE</code>
</h2>
<p>By default, R6 objects have a <code>clone()</code> method, which is a fairly large function. If you do not need this feature, you can save some memory by using <code>cloneable=FALSE</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>R6NonCloneable <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6NonCloneable"</span>,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">cloneable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> x,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() self<span class="sc">$</span>x,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> self<span class="sc">$</span>x <span class="sc">+</span> n</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="r6-class-without-class-attribute-non-portable-and-non-cloneable" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class-without-class-attribute-non-portable-and-non-cloneable" class="anchor"></a>R6 class, without class attribute, non-portable, and non-cloneable</h2>
<p>For comparison, we’ll use a an R6 class that is without a class attribute, non-portable, and non-cloneable. This is the most stripped-down we can make an R6 object.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>R6Bare <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6Bare"</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">portable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cloneable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="cn">NULL</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">value =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> value,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() x,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="r6-class-with-public-and-private-members" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class-with-public-and-private-members" class="anchor"></a>R6 class, with public and private members</h2>
<p>This variant has public and private members.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>R6Private <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6Private"</span>,</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="cn">NULL</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) private<span class="sc">$</span>x <span class="ot">&lt;-</span> x,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() private<span class="sc">$</span>x,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) private<span class="sc">$</span>x <span class="ot">&lt;-</span> private<span class="sc">$</span>x <span class="sc">+</span> n</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Instead of a single <code>self</code> object which refers to all items in an object, these objects have <code>self</code> (which refers to the public items) and <code>private</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>R6Private<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; &lt;R6Private&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Public:</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     getx: function () </span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     inc: function (n = 1) </span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     initialize: function (x = 1) </span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   Private:</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;     x: 1</span></span></code></pre></div>
</div>
<div id="r6-class-with-public-and-private-no-class-attribute-non-portable-and-non-cloneable" class="section level2">
<h2 class="hasAnchor">
<a href="#r6-class-with-public-and-private-no-class-attribute-non-portable-and-non-cloneable" class="anchor"></a>R6 class, with public and private, no class attribute, non-portable, and non-cloneable</h2>
<p>For comparison, we’ll add a version that is without a class attribute, non-portable, and non-cloneable.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>R6PrivateBare <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6PrivateBare"</span>,</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">portable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">class =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">cloneable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">private =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="cn">NULL</span>),</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) private<span class="sc">$</span>x <span class="ot">&lt;-</span> x,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">getx =</span> <span class="cf">function</span>() x,</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
</div>
<div id="environment-created-by-a-function-call-with-class-attribute" class="section level2">
<h2 class="hasAnchor">
<a href="#environment-created-by-a-function-call-with-class-attribute" class="anchor"></a>Environment created by a function call, with class attribute</h2>
<p>In R, environments are passed by reference. A simple way to create an object that’s passed by reference is to use the environment created by the invocation of a function. The function below captures that environment, attaches a class to it, and returns it:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>FunctionEnvClass <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) {</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  inc <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>  getx <span class="ot">&lt;-</span> <span class="cf">function</span>() x</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>  self <span class="ot">&lt;-</span> <span class="fu">environment</span>()</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class</span>(self) <span class="ot">&lt;-</span> <span class="st">"FunctionEnvClass"</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>  self</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Even though <code>x</code> isn’t declared in the function body, it gets captured because it’s an argument to the function.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>(<span class="fu">FunctionEnvClass</span>())</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "getx" "inc"  "self" "x"</span></span></code></pre></div>
<p>Objects created this way are very similar to those created by <code>R6</code> generator we created above.</p>
</div>
<div id="environment-created-by-a-function-call-without-class-attribute" class="section level2">
<h2 class="hasAnchor">
<a href="#environment-created-by-a-function-call-without-class-attribute" class="anchor"></a>Environment created by a function call, without class attribute</h2>
<p>We can make an even simpler type of reference object to the previous one, by not having a a class attribute, and not having <code>self</code> object:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>FunctionEnvNoClass <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">1</span>) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  inc <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">+</span> n</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  getx <span class="ot">&lt;-</span> <span class="cf">function</span>() x</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">environment</span>()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>This is simply an environment with some objects in it.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span>(<span class="fu">FunctionEnvNoClass</span>())</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "getx" "inc"  "x"</span></span></code></pre></div>
<hr>
</div>
</div>
<div id="tests" class="section level1">
<h1 class="hasAnchor">
<a href="#tests" class="anchor"></a>Tests</h1>
<p>For all the timings using <code>microbenchmark()</code>, the results are reported in microseconds, and the most useful value is probably the median column.</p>
<div id="memory-footprint" class="section level2">
<h2 class="hasAnchor">
<a href="#memory-footprint" class="anchor"></a>Memory footprint</h2>
<p>How much memory does a single instance of each object take, and how much memory does each additional object take? We’ll use the functions <code>obj_size</code> and <code>obj_sizes</code> (shown at the bottom of this document) to calculate the sizes.</p>
<p>Sizes of each type of object, in bytes:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>sizes <span class="ot">&lt;-</span> <span class="fu">obj_sizes</span>(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>  RC<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>  R6<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>  R6NoClass<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  R6NonPortable<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  R6NonCloneable<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>  R6Bare<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  R6Private<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  R6PrivateBare<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FunctionEnvClass</span>(),</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FunctionEnvNoClass</span>()</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>sizes</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;                          one incremental</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; RC$new()             1095384        1736</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6$new()               96640        1016</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6NoClass$new()        97360         896</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6NonPortable$new()    96312         960</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6NonCloneable$new()   14288         904</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6Bare$new()           13488         728</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6Private$new()        97552        1128</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R6PrivateBare$new()    14512         840</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; FunctionEnvClass()     13424         616</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; FunctionEnvNoClass()   11944         504</span></span></code></pre></div>
<p>The results are plotted below. Note that the plots have very different x scales.</p>
<p><img src="Performance_files/figure-html/unnamed-chunk-22-1.png" width="374.4"><img src="Performance_files/figure-html/unnamed-chunk-22-2.png" width="374.4"></p>
<p>Some preliminary observations about the first instance of various classes: Using a reference class consumes a large amount of memory. For R6 objects, the option with the largest impact is <code>cloneable</code>: not having the <code>clone()</code> method saves around 40 kB of memory.</p>
<p>For subsequent instances of these classes, there isn’t nearly as much difference between the different kinds.</p>
<p>It appeared that using a reference class takes up a huge amount of memory, but much of that is shared between reference classes. Adding an object from a different reference class doesn’t require much more memory — around 38KB:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>RC2 <span class="ot">&lt;-</span> <span class="fu">setRefClass</span>(<span class="st">"RC2"</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="st">"numeric"</span>),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="dv">2</span>) .self<span class="sc">$</span>x <span class="ot">&lt;&lt;-</span> x,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">inc =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2</span>) x <span class="ot">&lt;&lt;-</span> x <span class="sc">*</span> n</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Calcualte the size of a new RC2 object, over and above an RC object</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">as.numeric</span>(<span class="fu">object_size</span>(RC<span class="sc">$</span><span class="fu">new</span>(), RC2<span class="sc">$</span><span class="fu">new</span>()) <span class="sc">-</span> <span class="fu">object_size</span>(RC<span class="sc">$</span><span class="fu">new</span>()))</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] 30888</span></span></code></pre></div>
</div>
<div id="object-instantiation-speed" class="section level2">
<h2 class="hasAnchor">
<a href="#object-instantiation-speed" class="anchor"></a>Object instantiation speed</h2>
<p>How much time does it take to create one of these objects? This shows the median time, in microseconds:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract the medians from microbenchmark results</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>mb_summary <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>  res <span class="ot">&lt;-</span> <span class="fu">summary</span>(x, <span class="at">unit=</span><span class="st">"us"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">name =</span> res<span class="sc">$</span>expr, <span class="at">median =</span> res<span class="sc">$</span>median)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>  RC<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  R6<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  R6NoClass<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>  R6NonPortable<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>  R6NonCloneable<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>  R6Bare<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>  R6Private<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>  R6PrivateBare<span class="sc">$</span><span class="fu">new</span>(),</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FunctionEnvClass</span>(),</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">FunctionEnvNoClass</span>()</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">mb_summary</span>(speed)</span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>speed</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p>The plot below shows the median instantiation time.</p>
<p><img src="Performance_files/figure-html/unnamed-chunk-25-1.png" width="768"></p>
<p>Reference classes are much slower to instantiate than the other types of classes. Instantiating R6 objects is roughly 5 times faster. Creating an environment with a simple function call is another 20-30 times faster.</p>
</div>
<div id="field-access-speed" class="section level2">
<h2 class="hasAnchor">
<a href="#field-access-speed" class="anchor"></a>Field access speed</h2>
<p>How much time does it take to access a field in an object? First we’ll make some objects:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>rc           <span class="ot">&lt;-</span> RC<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>r6           <span class="ot">&lt;-</span> R6<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>r6noclass    <span class="ot">&lt;-</span> R6NoClass<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>r6noport     <span class="ot">&lt;-</span> R6NonPortable<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>r6noclone    <span class="ot">&lt;-</span> R6NonCloneable<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>r6bare       <span class="ot">&lt;-</span> R6Bare<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>r6priv       <span class="ot">&lt;-</span> R6Private<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>r6priv_bare  <span class="ot">&lt;-</span> R6PrivateBare<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>fun_env      <span class="ot">&lt;-</span> <span class="fu">FunctionEnvClass</span>()</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>fun_env_nc   <span class="ot">&lt;-</span> <span class="fu">FunctionEnvNoClass</span>()</span></code></pre></div>
<p>And then get a value from these objects:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  rc<span class="sc">$</span>x,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  r6<span class="sc">$</span>x,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  r6noclass<span class="sc">$</span>x,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  r6noport<span class="sc">$</span>x,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  r6noclone<span class="sc">$</span>x,</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  r6bare<span class="sc">$</span>x,</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>  r6priv<span class="sc">$</span>x,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  r6priv_bare<span class="sc">$</span>x,</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  fun_env<span class="sc">$</span>x,</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  fun_env_nc<span class="sc">$</span>x</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">mb_summary</span>(speed)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>speed</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-28-1.png" width="768"></p>
<p>Accessing the field of a reference class is much slower than the other methods.</p>
<p>There’s also an obvious pattern where accessing the field of an environment (created by R6 or a function call) is slower when there is a class attribute. This is because, for the objects that have a class attribute, R attempts to look up an S3 method for <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>, and this lookup has a performance penalty. We’ll see more about this below.</p>
</div>
<div id="field-setting-speed" class="section level2">
<h2 class="hasAnchor">
<a href="#field-setting-speed" class="anchor"></a>Field setting speed</h2>
<p>How much time does it take to set the value of a field in an object?</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>  rc<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>  r6<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>  r6noclass<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>  r6noport<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  r6noclone<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  r6bare<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="co"># r6priv$x &lt;- 4,         # Can't set private field directly,</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># r6priv_nc_np$x &lt;- 4,   # so we'll skip these two</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  fun_env<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span>,</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>  fun_env_nc<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">mb_summary</span>(speed)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>speed</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-30-1.png" width="768"></p>
<p>Reference classes are significantly slower than the others, again. In this case, there’s additional overhead due to type-checking the value.</p>
<p>Once more, the no-class objects are significantly faster than the others, again probably due to attempted S3 dispatch on the <code>`$&lt;-`</code> function.</p>
</div>
<div id="speed-of-method-call-that-accesses-a-field" class="section level2">
<h2 class="hasAnchor">
<a href="#speed-of-method-call-that-accesses-a-field" class="anchor"></a>Speed of method call that accesses a field</h2>
<p>How much overhead is there when calling a method from one of these objects? All of these <code>getx()</code> methods simply return the value of <code>x</code> in the object. When necessary, this method uses <code>self$x</code> (for R6 classes, when <code>portable=TRUE</code>), and in others, it just uses <code>x</code> (when <code>portable=FALSE</code>, and in reference classes).</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  rc<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  r6<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  r6noclass<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  r6noport<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  r6noclone<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  r6bare<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  r6priv<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  r6priv_bare<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  fun_env<span class="sc">$</span><span class="fu">getx</span>(),</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  fun_env_nc<span class="sc">$</span><span class="fu">getx</span>()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">mb_summary</span>(speed)</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>speed</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-32-1.png" width="768"></p>
<p>The reference class is the slowest.</p>
<p><code>r6</code> is also somewhat slower than the others. There are two reasons for this: first, it uses <code>self$x</code> which adds some time, and second, it has a class attribute, which slows down the access of both <code>r6$getx</code> and <code>self$x</code>.</p>
<p>One might expect <code>r6priv</code> to be the same speed as <code>r6</code>, but it is faster. Although accessing <code>r6priv$getx</code> is slow because <code>r6priv</code> has a class attribute, accessing <code>private$x</code> is faster because it does not have a class attribute.</p>
<p>The objects which can access <code>x</code> directly (without <code>self</code> or <code>private</code>) and which lack a class attribute are the fastest.</p>
</div>
<div id="assignment-using-selfx---vs--x--" class="section level2">
<h2 class="hasAnchor">
<a href="#assignment-using-selfx---vs--x--" class="anchor"></a>Assignment using <code>self$x &lt;-</code> vs. <code>x &lt;&lt;-</code>
</h2>
<p>With reference classes, you can modify fields using the <code>&lt;&lt;-</code> operator, or by using the <code>.self</code> object. For example, compare the <code>setx()</code> methods of these two classes:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>RCself <span class="ot">&lt;-</span> <span class="fu">setRefClass</span>(<span class="st">"RCself"</span>,</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="st">"numeric"</span>),</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() .self<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">1</span>,</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">setx =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2</span>) .self<span class="sc">$</span>x <span class="ot">&lt;-</span> n</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>RCnoself <span class="ot">&lt;-</span> <span class="fu">setRefClass</span>(<span class="st">"RCnoself"</span>,</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">fields =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="st">"numeric"</span>),</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">initialize =</span> <span class="cf">function</span>() x <span class="ot">&lt;&lt;-</span> <span class="dv">1</span>,</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">setx =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2</span>) x <span class="ot">&lt;&lt;-</span> n</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Non-portable R6 classes are similar, except they use <code>self</code> instead of <code>.self</code>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>R6self <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6self"</span>,</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">portable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span>,</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">setx =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2</span>) self<span class="sc">$</span>x <span class="ot">&lt;-</span> n</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>R6noself <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"R6noself"</span>,</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">portable =</span> <span class="cn">FALSE</span>,</span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="dv">1</span>,</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">setx =</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">2</span>) x <span class="ot">&lt;&lt;-</span> n</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>rc_self   <span class="ot">&lt;-</span> RCself<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>rc_noself <span class="ot">&lt;-</span> RCnoself<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>r6_self   <span class="ot">&lt;-</span> R6self<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>r6_noself <span class="ot">&lt;-</span> R6noself<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>  rc_self<span class="sc">$</span><span class="fu">setx</span>(),</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>  rc_noself<span class="sc">$</span><span class="fu">setx</span>(),</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  r6_self<span class="sc">$</span><span class="fu">setx</span>(),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  r6_noself<span class="sc">$</span><span class="fu">setx</span>()</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">mb_summary</span>(speed)</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>speed</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-36-1.png" width="768"></p>
<p>For both reference and non-portable R6 classes, assignment using <code>.self$x &lt;-</code> is somewhat slower than using <code>x &lt;&lt;-</code>.</p>
<p>Bear in mind that, by default, R6 classes are portable, and can’t use assignment with <code>x &lt;&lt;-</code>.</p>
</div>
<div id="overhead-from-using-on-objects-with-a-class-attribute" class="section level2">
<h2 class="hasAnchor">
<a href="#overhead-from-using-on-objects-with-a-class-attribute" class="anchor"></a>Overhead from using <code>$</code> on objects with a class attribute</h2>
<p>There is some overhead when using <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> on an object that has a class attribute. In the test below, we’ll create three different kinds of objects:</p>
<ol style="list-style-type: decimal">
<li>An environment with no class attribute.</li>
<li>An environment with a class <code>"e2"</code>, but without a <code>$.e2</code> S3 method.</li>
<li>An environment with a class <code>"e3"</code>, which has a <code>$.e3</code> S3 method that simply returns <code>NULL</code>.</li>
</ol>
<p>Each one of these environments will contain an object <code>x</code>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>e1 <span class="ot">&lt;-</span> <span class="fu">new.env</span>(<span class="at">hash =</span> <span class="cn">FALSE</span>, <span class="at">parent =</span> <span class="fu">emptyenv</span>())</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>e2 <span class="ot">&lt;-</span> <span class="fu">new.env</span>(<span class="at">hash =</span> <span class="cn">FALSE</span>, <span class="at">parent =</span> <span class="fu">emptyenv</span>())</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>e3 <span class="ot">&lt;-</span> <span class="fu">new.env</span>(<span class="at">hash =</span> <span class="cn">FALSE</span>, <span class="at">parent =</span> <span class="fu">emptyenv</span>())</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>e1<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>e2<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>e3<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(e2) <span class="ot">&lt;-</span> <span class="st">"e2"</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="fu">class</span>(e3) <span class="ot">&lt;-</span> <span class="st">"e3"</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Define an S3 method for class e3</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="st">`</span><span class="at">$.e3</span><span class="st">`</span> <span class="ot">&lt;-</span> <span class="cf">function</span>(x, name) {</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we can run timing tests for calling <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> on each type of object. Note that for the <code>e3</code> object, the <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> function does nothing — it simply returns <code>NULL</code>.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">microbenchmark</span>(</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  e1<span class="sc">$</span>x,</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  e2<span class="sc">$</span>x,</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  e3<span class="sc">$</span>x</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>speed <span class="ot">&lt;-</span> <span class="fu">mb_summary</span>(speed)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>speed</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p>Using <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> on <code>e2</code> and <code>e3</code> is much slower than on <code>e1</code>. This is because <code>e2</code> and <code>e3</code> have a class attribute. Even though there’s no <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> method defined for <code>e2</code>, doing <code>e2$x</code> still about 6 times slower than <code>e1$x</code>, simply because R looks for an appropriate S3 method.</p>
<p><code>e3$x</code> is slightly faster than <code>e2$x</code>; this is probably because the <code>$.e3</code> function doesn’t actually do anything other than return NULL.</p>
<p>If an object has a class attribute, R will attempt to look for a method every time <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> is called. This can slow things down considerably, if <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> is used often.</p>
</div>
<div id="lists-vs--environments-and-vs-" class="section level2">
<h2 class="hasAnchor">
<a href="#lists-vs--environments-and-vs-" class="anchor"></a>Lists vs. environments, and <code>$</code> vs. <code>[[</code>
</h2>
<p>Lists could also be used for creating classes (albeit not with reference semantics). How much time does it take to access items using <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> for lists vs. environments? We’ll also compare using <code>obj$x</code> to <code>obj[['x']]</code>.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>lst <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">10</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>env <span class="ot">&lt;-</span> <span class="fu">new.env</span>()</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>env<span class="sc">$</span>x <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mb_summary</span>(<span class="fu">microbenchmark</span>(</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">lst =</span> lst<span class="sc">$</span>x,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">env =</span> env<span class="sc">$</span>x,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  lst[[<span class="st">'x'</span>]],</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  env[[<span class="st">'x'</span>]]</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   name median</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1           0</span></span></code></pre></div>
<p>Performance is comparable across environments and lists.</p>
<p>The <code><a href="https://rdrr.io/r/base/Extract.html">[[</a></code> operator is slightly faster than <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>, probably because it doesn’t need to convert the unevaluated symbol to a string.</p>
<hr>
</div>
</div>
<div id="wrap-up" class="section level1">
<h1 class="hasAnchor">
<a href="#wrap-up" class="anchor"></a>Wrap-up</h1>
<p>R6 objects take less memory and are significantly faster than R’s reference class objects, and they also have some options that provide for even more speed.</p>
<p>In these tests, the biggest speedup for R6 classes comes from not using a class attribute; this speeds up the use of <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code>. Non-portable R6 classes can also access fields without <code><a href="https://rdrr.io/r/base/Extract.html">$</a></code> at all, which provides another modest speed boost. In most cases, these speed increases are negligible – they are on the order of microseconds and will be noticeable only when tens or even hundreds of thousands of class member accesses are performed.</p>
<hr>
</div>
<div id="appendix" class="section level1">
<h1 class="hasAnchor">
<a href="#appendix" class="anchor"></a>Appendix</h1>
<div id="functions-for-calculating-object-sizes" class="section level2">
<h2 class="hasAnchor">
<a href="#functions-for-calculating-object-sizes" class="anchor"></a>Functions for calculating object sizes</h2>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Utility functions for calculating sizes</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>obj_size <span class="ot">&lt;-</span> <span class="cf">function</span>(expr, <span class="at">.env =</span> <span class="fu">parent.frame</span>()) {</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  size_n <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">n =</span> <span class="dv">1</span>) {</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    objs <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span>n, <span class="cf">function</span>(x) <span class="fu">eval</span>(expr, .env))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.numeric</span>(<span class="fu">do.call</span>(object_size, objs))</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">one =</span> <span class="fu">size_n</span>(<span class="dv">1</span>), <span class="at">incremental =</span> <span class="fu">size_n</span>(<span class="dv">2</span>) <span class="sc">-</span> <span class="fu">size_n</span>(<span class="dv">1</span>))</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>obj_sizes <span class="ot">&lt;-</span> <span class="cf">function</span>(..., <span class="at">.env =</span> <span class="fu">parent.frame</span>()) {</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  exprs <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">match.call</span>(<span class="at">expand.dots =</span> <span class="cn">FALSE</span>)<span class="sc">$</span>...)</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">names</span>(exprs) <span class="ot">&lt;-</span> <span class="fu">lapply</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(exprs),</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN =</span> <span class="cf">function</span>(n) {</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>      name <span class="ot">&lt;-</span> <span class="fu">names</span>(exprs)[n]</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is.null</span>(name) <span class="sc">||</span> name <span class="sc">==</span> <span class="st">""</span>) <span class="fu">paste</span>(<span class="fu">deparse</span>(exprs[[n]]), <span class="at">collapse =</span> <span class="st">" "</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span> name</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>  sizes <span class="ot">&lt;-</span> <span class="fu">mapply</span>(obj_size, exprs, <span class="at">MoreArgs =</span> <span class="fu">list</span>(<span class="at">.env =</span> .env), <span class="at">SIMPLIFY =</span> <span class="cn">FALSE</span>)</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">do.call</span>(rbind, sizes)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="system-information" class="section level2">
<h2 class="hasAnchor">
<a href="#system-information" class="anchor"></a>System information</h2>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; R version 4.1.1 (2021-08-10)</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Platform: x86_64-apple-darwin17.0 (64-bit)</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Running under: macOS Big Sur 10.16</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRblas.0.dylib</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.1/Resources/lib/libRlapack.dylib</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; locale:</span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] scales_1.1.1  ggplot2_3.3.5 R6_2.5.0.9001 pryr_0.1.5   </span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [1] Rcpp_1.0.7        highr_0.9         lobstr_1.1.1.9000 bslib_0.3.0      </span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [5] compiler_4.1.1    pillar_1.6.2      jquerylib_0.1.4   tools_4.1.1      </span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  [9] digest_0.6.28     jsonlite_1.7.2    evaluate_0.14     memoise_2.0.0    </span></span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [13] lifecycle_1.0.1   tibble_3.1.4      gtable_0.3.0      pkgconfig_2.0.3  </span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [17] rlang_0.4.11      DBI_1.1.1         yaml_2.2.1        pkgdown_1.4.1    </span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [21] xfun_0.25         fastmap_1.1.0     withr_2.4.2       dplyr_1.0.7      </span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [25] stringr_1.4.0     knitr_1.34        generics_0.1.0    vctrs_0.3.8      </span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [29] desc_1.4.0        fs_1.5.0          sass_0.4.0.9000   tidyselect_1.1.1 </span></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [33] rprojroot_2.0.2   grid_4.1.1        glue_1.4.2        fansi_0.5.0      </span></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [37] rmarkdown_2.10    farver_2.1.0      purrr_0.3.4       magrittr_2.0.1   </span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [41] codetools_0.2-18  htmltools_0.5.2   ellipsis_0.3.2    MASS_7.3-54      </span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [45] assertthat_0.2.1  colorspace_2.0-2  labeling_0.4.2    utf8_1.2.2       </span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [49] stringi_1.7.4     munsell_0.5.0     cachem_1.0.6      crayon_1.4.1</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">

        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li>
<a href="#class-definitions">Class definitions</a>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-reference-class">R reference class</a></li>
      <li><a href="#r6-class">R6 class</a></li>
      <li><a href="#r6-class-without-class-attribute">R6 class, without class attribute</a></li>
      <li><a href="#r6-class-non-portable">R6 class, non-portable</a></li>
      <li><a href="#r6-class-with-cloneablefalse">R6 class, with <code>cloneable=FALSE</code></a></li>
      <li><a href="#r6-class-without-class-attribute-non-portable-and-non-cloneable">R6 class, without class attribute, non-portable, and non-cloneable</a></li>
      <li><a href="#r6-class-with-public-and-private-members">R6 class, with public and private members</a></li>
      <li><a href="#r6-class-with-public-and-private-no-class-attribute-non-portable-and-non-cloneable">R6 class, with public and private, no class attribute, non-portable, and non-cloneable</a></li>
      <li><a href="#environment-created-by-a-function-call-with-class-attribute">Environment created by a function call, with class attribute</a></li>
      <li><a href="#environment-created-by-a-function-call-without-class-attribute">Environment created by a function call, without class attribute</a></li>
      </ul>
</li>
      <li>
<a href="#tests">Tests</a>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#memory-footprint">Memory footprint</a></li>
      <li><a href="#object-instantiation-speed">Object instantiation speed</a></li>
      <li><a href="#field-access-speed">Field access speed</a></li>
      <li><a href="#field-setting-speed">Field setting speed</a></li>
      <li><a href="#speed-of-method-call-that-accesses-a-field">Speed of method call that accesses a field</a></li>
      <li><a href="#assignment-using-selfx---vs--x--">Assignment using <code>self$x &lt;-</code> vs. <code>x &lt;&lt;-</code></a></li>
      <li><a href="#overhead-from-using-on-objects-with-a-class-attribute">Overhead from using <code>$</code> on objects with a class attribute</a></li>
      <li><a href="#lists-vs--environments-and-vs-">Lists vs. environments, and <code>$</code> vs. <code>[[</code></a></li>
      </ul>
</li>
      <li><a href="#wrap-up">Wrap-up</a></li>
      <li>
<a href="#appendix">Appendix</a>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#functions-for-calculating-object-sizes">Functions for calculating object sizes</a></li>
      <li><a href="#system-information">System information</a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Winston Chang.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.4.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
