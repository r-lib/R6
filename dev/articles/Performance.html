<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>R6 and Reference Class performance tests • R6</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="R6 and Reference Class performance tests">
<meta name="robots" content="noindex">
<script defer data-domain="r6.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">R6</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.5.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Introduction.html">Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/Portable.html">Portable and non-portable R6 classes</a></li>
    <li><a class="dropdown-item" href="../articles/Debugging.html">Debugging</a></li>
    <li><a class="dropdown-item" href="../articles/Performance.html">R6 and Reference Class performance tests</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/R6/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>R6 and Reference Class performance tests</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/R6/blob/main/vignettes/Performance.Rmd" class="external-link"><code>vignettes/Performance.Rmd</code></a></small>
      <div class="d-none name"><code>Performance.Rmd</code></div>
    </div>

    
    
<p>This document compares the memory costs and speed of R’s reference
classes against R6 classes and simple environments. For most uses, R6
and reference classes have comparable features, but as we’ll see, R6
classes are faster and more lightweight.</p>
<p>This document tests reference classes against R6 classes (in many
variations), as well as against very simple reference objects:
environments created by function calls.</p>
<hr>
<p>First we’ll load some packages which will be used below:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">microbenchmark</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>microbenchmark.unit <span class="op">=</span> <span class="st">"us"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lobstr.r-lib.org/" class="external-link">lobstr</a></span><span class="op">)</span>  <span class="co"># For obj_size function</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r6.r-lib.org">R6</a></span><span class="op">)</span></span></code></pre></div>
<hr>
<div class="section level2">
<h2 id="class-definitions">Class definitions<a class="anchor" aria-label="anchor" href="#class-definitions"></a>
</h2>
<p>We’ll start by defining a number of classes or class-like entities,
using reference classes, R6 classes, and simple environments that are
created directly by functions. There are a number of options for R6 that
can affect the size of the resulting objects, so we will use a number of
variants. These classes will be used for the speed and memory tests that
follow. This is a lot of boring code, so you may want to skip ahead to
the results.</p>
<p>All of these classes have the same basic characteristics:</p>
<ul>
<li>A field named <code>x</code> that contains a number.</li>
<li>An way of initializing the value of <code>x</code>.</li>
<li>A method named <code>getx</code> for retrieving the value of
<code>x</code>.</li>
<li>A method named <code>inc</code> for incrementing the value of
<code>x</code>.</li>
</ul>
<p>The fields and methods are accessed with the <code>$</code> operator,
so if we have an object named <code>obj</code>, we could use
<code>obj$x</code> or <code>obj$getx()</code>.</p>
<div class="section level3">
<h3 id="r-reference-class">R reference class<a class="anchor" aria-label="anchor" href="#r-reference-class"></a>
</h3>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RC</span> <span class="op">&lt;-</span> <span class="kw">setRefClass</span><span class="op">(</span><span class="st">"RC"</span>,</span>
<span>  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span>,</span>
<span>  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">.self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>In reference classes, the binding that points back to the object is
named <code>.self</code>. Within a method, assignment can be done by
using <code>.self</code>, as in <code>.self$x &lt;- 10</code>, or by
using <code>&lt;&lt;-</code>, as in <code>x &lt;&lt;- 10</code>.</p>
<p>To create an object, simply call <code>$new()</code> on the
class:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Reference class object of class "RC"</span></span>
<span><span class="co">#&gt; Field "x":</span></span>
<span><span class="co">#&gt; [1] 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r6-class">R6 class<a class="anchor" aria-label="anchor" href="#r6-class"></a>
</h3>
<p>Creating an R6 class is similar to the reference class, except that
there’s no need to separate the fields and methods, and you can’t
specify the types of the fields.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6"</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Whereas reference classes use <code>.self</code>, R6 classes use
<code>self</code> (without the leading period). As with reference
classes, objects are instantiated by calling <code>$new()</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va"><a href="../reference/R6Class.html">R6</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;R6&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     getx: function () </span></span>
<span><span class="co">#&gt;     inc: function (n = 1) </span></span>
<span><span class="co">#&gt;     initialize: function (x = 1) </span></span>
<span><span class="co">#&gt;     x: 1</span></span></code></pre></div>
<p>An R6 object essentially just a set of environments structured in a
particular way. The fields and methods for an R6 object have bindings
(that is, they have names) in the <em>public environment</em>. There is
also have a separate environment which is the <em>enclosing
environment</em> for methods (they “run in” an environment that contains
a binding named <code>self</code>, which is simply a reference to the
public environment).</p>
</div>
<div class="section level3">
<h3 id="r6-class-without-class-attribute">R6 class, without class attribute<a class="anchor" aria-label="anchor" href="#r6-class-without-class-attribute"></a>
</h3>
<p>By default, a class attribute is added to R6 objects. This attribute
adds a slight performance penalty because R will attempt to use S3
dispatch when using <code>$</code> on the object.</p>
<p>It’s possible generate objects without the class attribute, by using
<code>class=FALSE</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6NoClass</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6NoClass"</span>,</span>
<span>  class <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Note that without the class attribute, S3 method dispatch on the
objects is not possible.</p>
</div>
<div class="section level3">
<h3 id="r6-class-non-portable">R6 class, non-portable<a class="anchor" aria-label="anchor" href="#r6-class-non-portable"></a>
</h3>
<p>By default, R6 objects are <em>portable</em>. This means that
inheritance can be in classes that are in different packages. However,
it also requires the use of <code>self$</code> and <code>private$</code>
to access members, and this incurs a small performance penalty.</p>
<p>If <code>portable=FALSE</code> is used, members can be accessed
without using <code>self$</code>, and assignment can be done with
<code>&lt;&lt;-</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6NonPortable</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6NonPortable"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">value</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r6-class-with-cloneablefalse">R6 class, with <code>cloneable=FALSE</code><a class="anchor" aria-label="anchor" href="#r6-class-with-cloneablefalse"></a>
</h3>
<p>By default, R6 objects have a <code>clone()</code> method, which is a
fairly large function. If you do not need this feature, you can save
some memory by using <code>cloneable=FALSE</code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6NonCloneable</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6NonCloneable"</span>,</span>
<span>  cloneable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r6-class-without-class-attribute-non-portable-and-non-cloneable">R6 class, without class attribute, non-portable, and
non-cloneable<a class="anchor" aria-label="anchor" href="#r6-class-without-class-attribute-non-portable-and-non-cloneable"></a>
</h3>
<p>For comparison, we’ll use a an R6 class that is without a class
attribute, non-portable, and non-cloneable. This is the most
stripped-down we can make an R6 object.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6Bare</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6Bare"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  class <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cloneable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">value</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r6-class-with-public-and-private-members">R6 class, with public and private members<a class="anchor" aria-label="anchor" href="#r6-class-with-public-and-private-members"></a>
</h3>
<p>This variant has public and private members.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6Private</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6Private"</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">private</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">private</span><span class="op">$</span><span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">private</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">private</span><span class="op">$</span><span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Instead of a single <code>self</code> object which refers to all
items in an object, these objects have <code>self</code> (which refers
to the public items) and <code>private</code>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6Private</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;R6Private&gt;</span></span>
<span><span class="co">#&gt;   Public:</span></span>
<span><span class="co">#&gt;     clone: function (deep = FALSE) </span></span>
<span><span class="co">#&gt;     getx: function () </span></span>
<span><span class="co">#&gt;     inc: function (n = 1) </span></span>
<span><span class="co">#&gt;     initialize: function (x = 1) </span></span>
<span><span class="co">#&gt;   Private:</span></span>
<span><span class="co">#&gt;     x: 1</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="r6-class-with-public-and-private-no-class-attribute-non-portable-and-non-cloneable">R6 class, with public and private, no class attribute, non-portable,
and non-cloneable<a class="anchor" aria-label="anchor" href="#r6-class-with-public-and-private-no-class-attribute-non-portable-and-non-cloneable"></a>
</h3>
<p>For comparison, we’ll add a version that is without a class
attribute, non-portable, and non-cloneable.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6PrivateBare</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6PrivateBare"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  class <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  cloneable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">private</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span>,</span>
<span>    getx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="environment-created-by-a-function-call-with-class-attribute">Environment created by a function call, with class attribute<a class="anchor" aria-label="anchor" href="#environment-created-by-a-function-call-with-class-attribute"></a>
</h3>
<p>In R, environments are passed by reference. A simple way to create an
object that’s passed by reference is to use the environment created by
the invocation of a function. The function below captures that
environment, attaches a class to it, and returns it:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FunctionEnvClass</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="va">getx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span></span>
<span>  <span class="va">self</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">self</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"FunctionEnvClass"</span></span>
<span>  <span class="va">self</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Even though <code>x</code> isn’t declared in the function body, it
gets captured because it’s an argument to the function.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="fu">FunctionEnvClass</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "getx" "inc"  "self" "x"</span></span></code></pre></div>
<p>Objects created this way are very similar to those created by
<code>R6</code> generator we created above.</p>
</div>
<div class="section level3">
<h3 id="environment-created-by-a-function-call-without-class-attribute">Environment created by a function call, without class attribute<a class="anchor" aria-label="anchor" href="#environment-created-by-a-function-call-without-class-attribute"></a>
</h3>
<p>We can make an even simpler type of reference object to the previous
one, by not having a a class attribute, and not having <code>self</code>
object:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">FunctionEnvNoClass</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">inc</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">+</span> <span class="va">n</span></span>
<span>  <span class="va">getx</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This is simply an environment with some objects in it.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="fu">FunctionEnvNoClass</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "getx" "inc"  "x"</span></span></code></pre></div>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="tests">Tests<a class="anchor" aria-label="anchor" href="#tests"></a>
</h2>
<p>For all the timings using <code><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark()</a></code>, the results
are reported in microseconds, and the most useful value is probably the
median column.</p>
<div class="section level3">
<h3 id="memory-footprint">Memory footprint<a class="anchor" aria-label="anchor" href="#memory-footprint"></a>
</h3>
<p>How much memory does a single instance of each object take, and how
much memory does each additional object take? We’ll use the functions
<code>obj_size</code> and <code>obj_sizes</code> (shown at the bottom of
this document) to calculate the sizes.</p>
<p>Sizes of each type of object, in bytes:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_sizes</a></span><span class="op">(</span></span>
<span>  <span class="va">RC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va"><a href="../reference/R6Class.html">R6</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6NoClass</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6NonPortable</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6NonCloneable</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6Bare</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6Private</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6PrivateBare</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">FunctionEnvClass</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">FunctionEnvNoClass</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">sizes</span></span>
<span><span class="co">#&gt;                          one incremental</span></span>
<span><span class="co">#&gt; RC$new()             2032832        1400</span></span>
<span><span class="co">#&gt; R6$new()               97200        1016</span></span>
<span><span class="co">#&gt; R6NoClass$new()        97920         896</span></span>
<span><span class="co">#&gt; R6NonPortable$new()    96872         960</span></span>
<span><span class="co">#&gt; R6NonCloneable$new()   14288         904</span></span>
<span><span class="co">#&gt; R6Bare$new()           13488         728</span></span>
<span><span class="co">#&gt; R6Private$new()        98112        1128</span></span>
<span><span class="co">#&gt; R6PrivateBare$new()    14512         840</span></span>
<span><span class="co">#&gt; FunctionEnvClass()     13424         616</span></span>
<span><span class="co">#&gt; FunctionEnvNoClass()   11944         504</span></span></code></pre></div>
<p>The results are plotted below. Note that the plots have very
different x scales.</p>
<p><img src="Performance_files/figure-html/unnamed-chunk-22-1.png" width="374.4"><img src="Performance_files/figure-html/unnamed-chunk-22-2.png" width="374.4"></p>
<p>Some preliminary observations about the first instance of various
classes: Using a reference class consumes a large amount of memory. For
R6 objects, the option with the largest impact is
<code>cloneable</code>: not having the <code>clone()</code> method saves
around 40 kB of memory.</p>
<p>For subsequent instances of these classes, there isn’t nearly as much
difference between the different kinds.</p>
<p>It appeared that using a reference class takes up a huge amount of
memory, but much of that is shared between reference classes. Adding an
object from a different reference class doesn’t require much more memory
— around 38KB:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RC2</span> <span class="op">&lt;-</span> <span class="kw">setRefClass</span><span class="op">(</span><span class="st">"RC2"</span>,</span>
<span>  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span>,</span>
<span>  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">.self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span>,</span>
<span>    inc <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">x</span> <span class="op">*</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calcualte the size of a new RC2 object, over and above an RC object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">RC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>, <span class="va">RC2</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span><span class="op">(</span><span class="va">RC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0 0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="object-instantiation-speed">Object instantiation speed<a class="anchor" aria-label="anchor" href="#object-instantiation-speed"></a>
</h3>
<p>How much time does it take to create one of these objects? This shows
the median time, in microseconds:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Function to extract the medians from microbenchmark results</span></span>
<span><span class="va">mb_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">x</span>, unit<span class="op">=</span><span class="st">"us"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>name <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">expr</span>, median <span class="op">=</span> <span class="va">res</span><span class="op">$</span><span class="va">median</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">RC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va"><a href="../reference/R6Class.html">R6</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6NoClass</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6NonPortable</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6NonCloneable</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6Bare</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6Private</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">R6PrivateBare</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">FunctionEnvClass</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="fu">FunctionEnvNoClass</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu">mb_summary</span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="va">speed</span></span>
<span><span class="co">#&gt;                    name   median</span></span>
<span><span class="co">#&gt; 1              RC$new() 204.1005</span></span>
<span><span class="co">#&gt; 2              R6$new()  31.2135</span></span>
<span><span class="co">#&gt; 3       R6NoClass$new()  31.3035</span></span>
<span><span class="co">#&gt; 4   R6NonPortable$new()  31.6845</span></span>
<span><span class="co">#&gt; 5  R6NonCloneable$new()  31.4085</span></span>
<span><span class="co">#&gt; 6          R6Bare$new()  27.8320</span></span>
<span><span class="co">#&gt; 7       R6Private$new()  43.1850</span></span>
<span><span class="co">#&gt; 8   R6PrivateBare$new()  39.0180</span></span>
<span><span class="co">#&gt; 9    FunctionEnvClass()   1.4980</span></span>
<span><span class="co">#&gt; 10 FunctionEnvNoClass()   1.0120</span></span></code></pre></div>
<p>The plot below shows the median instantiation time.</p>
<p><img src="Performance_files/figure-html/unnamed-chunk-25-1.png" width="768"></p>
<p>Reference classes are much slower to instantiate than the other types
of classes. Instantiating R6 objects is roughly 5 times faster. Creating
an environment with a simple function call is another 20-30 times
faster.</p>
</div>
<div class="section level3">
<h3 id="field-access-speed">Field access speed<a class="anchor" aria-label="anchor" href="#field-access-speed"></a>
</h3>
<p>How much time does it take to access a field in an object? First
we’ll make some objects:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rc</span>           <span class="op">&lt;-</span> <span class="va">RC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6</span>           <span class="op">&lt;-</span> <span class="va"><a href="../reference/R6Class.html">R6</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6noclass</span>    <span class="op">&lt;-</span> <span class="va">R6NoClass</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6noport</span>     <span class="op">&lt;-</span> <span class="va">R6NonPortable</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6noclone</span>    <span class="op">&lt;-</span> <span class="va">R6NonCloneable</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6bare</span>       <span class="op">&lt;-</span> <span class="va">R6Bare</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6priv</span>       <span class="op">&lt;-</span> <span class="va">R6Private</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6priv_bare</span>  <span class="op">&lt;-</span> <span class="va">R6PrivateBare</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fun_env</span>      <span class="op">&lt;-</span> <span class="fu">FunctionEnvClass</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fun_env_nc</span>   <span class="op">&lt;-</span> <span class="fu">FunctionEnvNoClass</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>And then get a value from these objects:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">rc</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6noclass</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6noport</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6noclone</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6bare</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6priv</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">r6priv_bare</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">fun_env</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">fun_env_nc</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="op">)</span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu">mb_summary</span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="va">speed</span></span>
<span><span class="co">#&gt;             name median</span></span>
<span><span class="co">#&gt; 1           rc$x 5.7510</span></span>
<span><span class="co">#&gt; 2           r6$x 0.6510</span></span>
<span><span class="co">#&gt; 3    r6noclass$x 0.2155</span></span>
<span><span class="co">#&gt; 4     r6noport$x 0.6965</span></span>
<span><span class="co">#&gt; 5    r6noclone$x 0.7015</span></span>
<span><span class="co">#&gt; 6       r6bare$x 0.2200</span></span>
<span><span class="co">#&gt; 7       r6priv$x 0.7120</span></span>
<span><span class="co">#&gt; 8  r6priv_bare$x 0.2210</span></span>
<span><span class="co">#&gt; 9      fun_env$x 0.6420</span></span>
<span><span class="co">#&gt; 10  fun_env_nc$x 0.2210</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-28-1.png" width="768"></p>
<p>Accessing the field of a reference class is much slower than the
other methods.</p>
<p>There’s also an obvious pattern where accessing the field of an
environment (created by R6 or a function call) is slower when there is a
class attribute. This is because, for the objects that have a class
attribute, R attempts to look up an S3 method for <code>$</code>, and
this lookup has a performance penalty. We’ll see more about this
below.</p>
</div>
<div class="section level3">
<h3 id="field-setting-speed">Field setting speed<a class="anchor" aria-label="anchor" href="#field-setting-speed"></a>
</h3>
<p>How much time does it take to set the value of a field in an
object?</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">rc</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="va">r6</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="va">r6noclass</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="va">r6noport</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="va">r6noclone</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="va">r6bare</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="co"># r6priv$x &lt;- 4,         # Can't set private field directly,</span></span>
<span>  <span class="co"># r6priv_nc_np$x &lt;- 4,   # so we'll skip these two</span></span>
<span>  <span class="va">fun_env</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span>,</span>
<span>  <span class="va">fun_env_nc</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu">mb_summary</span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="va">speed</span></span>
<span><span class="co">#&gt;                name  median</span></span>
<span><span class="co">#&gt; 1         rc$x &lt;- 4 30.5470</span></span>
<span><span class="co">#&gt; 2         r6$x &lt;- 4  1.1670</span></span>
<span><span class="co">#&gt; 3  r6noclass$x &lt;- 4  0.6915</span></span>
<span><span class="co">#&gt; 4   r6noport$x &lt;- 4  1.2525</span></span>
<span><span class="co">#&gt; 5  r6noclone$x &lt;- 4  1.2720</span></span>
<span><span class="co">#&gt; 6     r6bare$x &lt;- 4  0.7110</span></span>
<span><span class="co">#&gt; 7    fun_env$x &lt;- 4  1.1820</span></span>
<span><span class="co">#&gt; 8 fun_env_nc$x &lt;- 4  0.6865</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-30-1.png" width="768"></p>
<p>Reference classes are significantly slower than the others, again. In
this case, there’s additional overhead due to type-checking the
value.</p>
<p>Once more, the no-class objects are significantly faster than the
others, again probably due to attempted S3 dispatch on the
<code>`$&lt;-`</code> function.</p>
</div>
<div class="section level3">
<h3 id="speed-of-method-call-that-accesses-a-field">Speed of method call that accesses a field<a class="anchor" aria-label="anchor" href="#speed-of-method-call-that-accesses-a-field"></a>
</h3>
<p>How much overhead is there when calling a method from one of these
objects? All of these <code>getx()</code> methods simply return the
value of <code>x</code> in the object. When necessary, this method uses
<code>self$x</code> (for R6 classes, when <code>portable=TRUE</code>),
and in others, it just uses <code>x</code> (when
<code>portable=FALSE</code>, and in reference classes).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">rc</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6noclass</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6noport</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6noclone</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6bare</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6priv</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6priv_bare</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">fun_env</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">fun_env_nc</span><span class="op">$</span><span class="fu">getx</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu">mb_summary</span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="va">speed</span></span>
<span><span class="co">#&gt;                  name median</span></span>
<span><span class="co">#&gt; 1           rc$getx() 5.9410</span></span>
<span><span class="co">#&gt; 2           r6$getx() 1.5630</span></span>
<span><span class="co">#&gt; 3    r6noclass$getx() 0.5510</span></span>
<span><span class="co">#&gt; 4     r6noport$getx() 0.8520</span></span>
<span><span class="co">#&gt; 5    r6noclone$getx() 1.6530</span></span>
<span><span class="co">#&gt; 6       r6bare$getx() 0.3610</span></span>
<span><span class="co">#&gt; 7       r6priv$getx() 1.0620</span></span>
<span><span class="co">#&gt; 8  r6priv_bare$getx() 0.3655</span></span>
<span><span class="co">#&gt; 9      fun_env$getx() 0.9120</span></span>
<span><span class="co">#&gt; 10  fun_env_nc$getx() 0.4710</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-32-1.png" width="768"></p>
<p>The reference class is the slowest.</p>
<p><code>r6</code> is also somewhat slower than the others. There are
two reasons for this: first, it uses <code>self$x</code> which adds some
time, and second, it has a class attribute, which slows down the access
of both <code>r6$getx</code> and <code>self$x</code>.</p>
<p>One might expect <code>r6priv</code> to be the same speed as
<code>r6</code>, but it is faster. Although accessing
<code>r6priv$getx</code> is slow because <code>r6priv</code> has a class
attribute, accessing <code>private$x</code> is faster because it does
not have a class attribute.</p>
<p>The objects which can access <code>x</code> directly (without
<code>self</code> or <code>private</code>) and which lack a class
attribute are the fastest.</p>
</div>
<div class="section level3">
<h3 id="assignment-using-selfx---vs--x--">Assignment using <code>self$x &lt;-</code>
vs. <code>x &lt;&lt;-</code><a class="anchor" aria-label="anchor" href="#assignment-using-selfx---vs--x--"></a>
</h3>
<p>With reference classes, you can modify fields using the
<code>&lt;&lt;-</code> operator, or by using the <code>.self</code>
object. For example, compare the <code>setx()</code> methods of these
two classes:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">RCself</span> <span class="op">&lt;-</span> <span class="kw">setRefClass</span><span class="op">(</span><span class="st">"RCself"</span>,</span>
<span>  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span>,</span>
<span>  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">.self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span>,</span>
<span>    setx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">.self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">RCnoself</span> <span class="op">&lt;-</span> <span class="kw">setRefClass</span><span class="op">(</span><span class="st">"RCnoself"</span>,</span>
<span>  fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"numeric"</span><span class="op">)</span>,</span>
<span>  methods <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="fl">1</span>,</span>
<span>    setx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Non-portable R6 classes are similar, except they use
<code>self</code> instead of <code>.self</code>.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">R6self</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6self"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    setx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">self</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">R6noself</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"R6noself"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    setx <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;&lt;-</span> <span class="va">n</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rc_self</span>   <span class="op">&lt;-</span> <span class="va">RCself</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rc_noself</span> <span class="op">&lt;-</span> <span class="va">RCnoself</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6_self</span>   <span class="op">&lt;-</span> <span class="va">R6self</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r6_noself</span> <span class="op">&lt;-</span> <span class="va">R6noself</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">rc_self</span><span class="op">$</span><span class="fu">setx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">rc_noself</span><span class="op">$</span><span class="fu">setx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6_self</span><span class="op">$</span><span class="fu">setx</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="va">r6_noself</span><span class="op">$</span><span class="fu">setx</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu">mb_summary</span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="va">speed</span></span>
<span><span class="co">#&gt;               name  median</span></span>
<span><span class="co">#&gt; 1   rc_self$setx() 36.7235</span></span>
<span><span class="co">#&gt; 2 rc_noself$setx() 20.4730</span></span>
<span><span class="co">#&gt; 3   r6_self$setx()  2.9305</span></span>
<span><span class="co">#&gt; 4 r6_noself$setx()  1.3370</span></span></code></pre></div>
<p><img src="Performance_files/figure-html/unnamed-chunk-36-1.png" width="768"></p>
<p>For both reference and non-portable R6 classes, assignment using
<code>.self$x &lt;-</code> is somewhat slower than using
<code>x &lt;&lt;-</code>.</p>
<p>Bear in mind that, by default, R6 classes are portable, and can’t use
assignment with <code>x &lt;&lt;-</code>.</p>
</div>
<div class="section level3">
<h3 id="overhead-from-using-on-objects-with-a-class-attribute">Overhead from using <code>$</code> on objects with a class
attribute<a class="anchor" aria-label="anchor" href="#overhead-from-using-on-objects-with-a-class-attribute"></a>
</h3>
<p>There is some overhead when using <code>$</code> on an object that
has a class attribute. In the test below, we’ll create three different
kinds of objects:</p>
<ol style="list-style-type: decimal">
<li>An environment with no class attribute.</li>
<li>An environment with a class <code>"e2"</code>, but without a
<code>$.e2</code> S3 method.</li>
<li>An environment with a class <code>"e3"</code>, which has a
<code>$.e3</code> S3 method that simply returns <code>NULL</code>.</li>
</ol>
<p>Each one of these environments will contain an object
<code>x</code>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">e1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>hash <span class="op">=</span> <span class="cn">FALSE</span>, parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>hash <span class="op">=</span> <span class="cn">FALSE</span>, parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">e3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>hash <span class="op">=</span> <span class="cn">FALSE</span>, parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">e1</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">e2</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">e3</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">e2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"e2"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">e3</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"e3"</span></span>
<span></span>
<span><span class="co"># Define an S3 method for class e3</span></span>
<span><span class="va">`$.e3`</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">name</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="cn">NULL</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now we can run timing tests for calling <code>$</code> on each type
of object. Note that for the <code>e3</code> object, the <code>$</code>
function does nothing — it simply returns <code>NULL</code>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  <span class="va">e1</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">e2</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">e3</span><span class="op">$</span><span class="va">x</span></span>
<span><span class="op">)</span></span>
<span><span class="va">speed</span> <span class="op">&lt;-</span> <span class="fu">mb_summary</span><span class="op">(</span><span class="va">speed</span><span class="op">)</span></span>
<span><span class="va">speed</span></span>
<span><span class="co">#&gt;   name median</span></span>
<span><span class="co">#&gt; 1 e1$x 0.2000</span></span>
<span><span class="co">#&gt; 2 e2$x 0.5565</span></span>
<span><span class="co">#&gt; 3 e3$x 0.8515</span></span></code></pre></div>
<p>Using <code>$</code> on <code>e2</code> and <code>e3</code> is much
slower than on <code>e1</code>. This is because <code>e2</code> and
<code>e3</code> have a class attribute. Even though there’s no
<code>$</code> method defined for <code>e2</code>, doing
<code>e2$x</code> still about 6 times slower than <code>e1$x</code>,
simply because R looks for an appropriate S3 method.</p>
<p><code>e3$x</code> is slightly faster than <code>e2$x</code>; this is
probably because the <code>$.e3</code> function doesn’t actually do
anything other than return NULL.</p>
<p>If an object has a class attribute, R will attempt to look for a
method every time <code>$</code> is called. This can slow things down
considerably, if <code>$</code> is used often.</p>
</div>
<div class="section level3">
<h3 id="lists-vs--environments-and-vs-">Lists vs. environments, and <code>$</code> vs. <code>[[</code><a class="anchor" aria-label="anchor" href="#lists-vs--environments-and-vs-"></a>
</h3>
<p>Lists could also be used for creating classes (albeit not with
reference semantics). How much time does it take to access items using
<code>$</code> for lists vs. environments? We’ll also compare using
<code>obj$x</code> to <code>obj[['x']]</code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">env</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="fu">mb_summary</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>  lst <span class="op">=</span> <span class="va">lst</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  env <span class="op">=</span> <span class="va">env</span><span class="op">$</span><span class="va">x</span>,</span>
<span>  <span class="va">lst</span><span class="op">[[</span><span class="st">'x'</span><span class="op">]</span><span class="op">]</span>,</span>
<span>  <span class="va">env</span><span class="op">[[</span><span class="st">'x'</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;         name median</span></span>
<span><span class="co">#&gt; 1        lst  0.181</span></span>
<span><span class="co">#&gt; 2        env  0.170</span></span>
<span><span class="co">#&gt; 3 lst[["x"]]  0.140</span></span>
<span><span class="co">#&gt; 4 env[["x"]]  0.111</span></span></code></pre></div>
<p>Performance is comparable across environments and lists.</p>
<p>The <code>[[</code> operator is slightly faster than <code>$</code>,
probably because it doesn’t need to convert the unevaluated symbol to a
string.</p>
<hr>
</div>
</div>
<div class="section level2">
<h2 id="wrap-up">Wrap-up<a class="anchor" aria-label="anchor" href="#wrap-up"></a>
</h2>
<p>R6 objects take less memory and are significantly faster than R’s
reference class objects, and they also have some options that provide
for even more speed.</p>
<p>In these tests, the biggest speedup for R6 classes comes from not
using a class attribute; this speeds up the use of <code>$</code>.
Non-portable R6 classes can also access fields without <code>$</code> at
all, which provides another modest speed boost. In most cases, these
speed increases are negligible – they are on the order of microseconds
and will be noticeable only when tens or even hundreds of thousands of
class member accesses are performed.</p>
<hr>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<div class="section level3">
<h3 id="functions-for-calculating-object-sizes">Functions for calculating object sizes<a class="anchor" aria-label="anchor" href="#functions-for-calculating-object-sizes"></a>
</h3>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Utility functions for calculating sizes</span></span>
<span><span class="va">obj_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">expr</span>, <span class="va">.env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">size_n</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">objs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">expr</span>, <span class="va">.env</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="fu">lobstr</span><span class="fu">::</span><span class="va"><a href="https://lobstr.r-lib.org/reference/obj_size.html" class="external-link">obj_size</a></span>, <span class="va">objs</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>one <span class="op">=</span> <span class="fu">size_n</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, incremental <span class="op">=</span> <span class="fu">size_n</span><span class="op">(</span><span class="fl">2</span><span class="op">)</span> <span class="op">-</span> <span class="fu">size_n</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">obj_sizes</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span>, <span class="va">.env</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sys.parent.html" class="external-link">parent.frame</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">exprs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/match.call.html" class="external-link">match.call</a></span><span class="op">(</span>expand.dots <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">$</span><span class="va">...</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">exprs</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">exprs</span><span class="op">)</span>,</span>
<span>    FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">exprs</span><span class="op">)</span><span class="op">[</span><span class="va">n</span><span class="op">]</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">||</span> <span class="va">name</span> <span class="op">==</span> <span class="st">""</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/deparse.html" class="external-link">deparse</a></span><span class="op">(</span><span class="va">exprs</span><span class="op">[[</span><span class="va">n</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">" "</span><span class="op">)</span></span>
<span>      <span class="kw">else</span> <span class="va">name</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">sizes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="va">obj_size</span>, <span class="va">exprs</span>, MoreArgs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>.env <span class="op">=</span> <span class="va">.env</span><span class="op">)</span>, SIMPLIFY <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="va">sizes</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="system-information">System information<a class="anchor" aria-label="anchor" href="#system-information"></a>
</h3>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.4.1 (2024-06-14)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 22.04.4 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.20.so;  LAPACK version 3.10.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; other attached packages:</span></span>
<span><span class="co">#&gt; [1] scales_1.3.0          ggplot2_3.5.1         R6_2.5.1.9000        </span></span>
<span><span class="co">#&gt; [4] lobstr_1.1.2          microbenchmark_1.4.10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] gtable_0.3.5      jsonlite_1.8.8    highr_0.11       </span></span>
<span><span class="co">#&gt;  [4] compiler_4.4.1    jquerylib_0.1.4   systemfonts_1.1.0</span></span>
<span><span class="co">#&gt;  [7] textshaping_0.4.0 yaml_2.3.10       fastmap_1.2.0    </span></span>
<span><span class="co">#&gt; [10] labeling_0.4.3    knitr_1.48        tibble_3.2.1     </span></span>
<span><span class="co">#&gt; [13] desc_1.4.3        munsell_0.5.1     bslib_0.8.0      </span></span>
<span><span class="co">#&gt; [16] pillar_1.9.0      rlang_1.1.4       utf8_1.2.4       </span></span>
<span><span class="co">#&gt; [19] cachem_1.1.0      xfun_0.47         fs_1.6.4         </span></span>
<span><span class="co">#&gt; [22] sass_0.4.9        cli_3.6.3         pkgdown_2.1.0    </span></span>
<span><span class="co">#&gt; [25] withr_3.0.1       magrittr_2.0.3    digest_0.6.37    </span></span>
<span><span class="co">#&gt; [28] grid_4.4.1        lifecycle_1.0.4   vctrs_0.6.5      </span></span>
<span><span class="co">#&gt; [31] evaluate_0.24.0   glue_1.7.0        farver_2.1.2     </span></span>
<span><span class="co">#&gt; [34] codetools_0.2-20  ragg_1.3.2        fansi_1.0.6      </span></span>
<span><span class="co">#&gt; [37] colorspace_2.1-1  rmarkdown_2.28    tools_4.4.1      </span></span>
<span><span class="co">#&gt; [40] pkgconfig_2.0.3   htmltools_0.5.8.1</span></span></code></pre></div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/wch" class="external-link">Winston Chang</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

  </div></footer>
</body>
</html>
