<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="R6">
<title>Portable and non-portable R6 classes • R6</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.7/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.7/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Portable and non-portable R6 classes">
<meta property="og:description" content="R6">
<meta property="og:image" content="https://r6.r-lib.org/logo.svg">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="r6.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">R6</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">2.5.1.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Introduction.html">Introduction</a>
    <a class="dropdown-item" href="../articles/Portable.html">Portable and non-portable R6 classes</a>
    <a class="dropdown-item" href="../articles/Debugging.html">Debugging</a>
    <a class="dropdown-item" href="../articles/Performance.html">R6 and Reference Class performance tests</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-lib/R6/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Portable and non-portable R6 classes</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/R6/blob/HEAD/vignettes/Portable.Rmd" class="external-link"><code>vignettes/Portable.Rmd</code></a></small>
      <div class="d-none name"><code>Portable.Rmd</code></div>
    </div>

    
    
<p>One limitation to R’s reference classes is that class inheritance
across package namespaces is limited. R6 avoids this problem when the
<code>portable</code> option is enabled.</p>
<div class="section level2">
<h2 id="the-problem">The problem<a class="anchor" aria-label="anchor" href="#the-problem"></a>
</h2>
<p>Here is an example of the cross-package inheritance problem with
reference classes: Suppose you have ClassA in pkgA, and ClassB in pkgB,
which inherits from ClassA. ClassA has a method <code>foo</code> which
calls a non-exported function <code>fun</code> in pkgA.</p>
<p>If ClassB inherits <code>foo</code>, it will try to call
<code>fun</code> – but since ClassB objects are created in pkgB
namespace (which is an environment) instead of the pkgA namespace, it
won’t be able to find <code>fun</code>.</p>
<p>Something similar happens with R6 when the
<code>portable=FALSE</code> option is used. For example:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r6.r-lib.org">R6</a></span><span class="op">)</span></span>
<span><span class="co"># Simulate packages by creating environments</span></span>
<span><span class="va">pkgA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pkgB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a function in pkgA but not pkgB</span></span>
<span><span class="va">pkgA</span><span class="op">$</span><span class="va">fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fl">10</span></span>
<span></span>
<span><span class="va">ClassA</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"ClassA"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    foo <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">fun</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  parent_env <span class="op">=</span> <span class="va">pkgA</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ClassB inherits from ClassA</span></span>
<span><span class="va">ClassB</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"ClassB"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  inherit <span class="op">=</span> <span class="va">ClassA</span>,</span>
<span>  parent_env <span class="op">=</span> <span class="va">pkgB</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>When we create an instance of ClassA, it works as expected:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">ClassA</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">a</span><span class="op">$</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 10</span></span></code></pre></div>
<p>But with ClassB, it can’t find the <code>foo</code> function:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">ClassB</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in b$foo() : could not find function "fun"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="portable-r6">Portable R6<a class="anchor" aria-label="anchor" href="#portable-r6"></a>
</h2>
<p>R6 supports inheritance across different packages, with the default
<code>portable=TRUE</code> option. In this example, we’ll again simulate
different packages by creating separate parent environments for the
classes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkgA</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pkgB</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pkgA</span><span class="op">$</span><span class="va">fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="st">"This function `fun` in pkgA"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ClassA</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"ClassA"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">TRUE</span>,  <span class="co"># The default</span></span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    foo <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">fun</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  parent_env <span class="op">=</span> <span class="va">pkgA</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ClassB</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"ClassB"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  inherit <span class="op">=</span> <span class="va">ClassA</span>,</span>
<span>  parent_env <span class="op">=</span> <span class="va">pkgB</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">a</span> <span class="op">&lt;-</span> <span class="va">ClassA</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">a</span><span class="op">$</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "This function `fun` in pkgA"</span></span>
<span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">ClassB</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">b</span><span class="op">$</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "This function `fun` in pkgA"</span></span></code></pre></div>
<p>When a method is inherited from a superclass, that method also gets
that class’s environment. In other words, method “runs in” the
superclass’s environment. This makes it possible for inheritance to work
across packages.</p>
<p>When a method is defined in the subclass, that method gets the
subclass’s environment. For example, here ClassC is a subclass of
ClassA, and defines its own <code>foo</code> method which overrides the
<code>foo</code> method from ClassA. It happens that the method looks
the same as ClassA’s – it just calls <code>fun</code>. But this time it
finds <code>pkgC$fun</code> instead of <code>pkgA$fun</code>. This is in
contrast to ClassB, which inherited the <code>foo</code> method and
environment from ClassA.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pkgC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">pkgC</span><span class="op">$</span><span class="va">fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="st">"This function `fun` in pkgC"</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ClassC</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"ClassC"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  inherit <span class="op">=</span> <span class="va">ClassA</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    foo <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">fun</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  parent_env <span class="op">=</span> <span class="va">pkgC</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">cc</span> <span class="op">&lt;-</span> <span class="va">ClassC</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># This method is defined in ClassC, so finds pkgC$fun</span></span>
<span><span class="va">cc</span><span class="op">$</span><span class="fu">foo</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "This function `fun` in pkgC"</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="using-self">Using <code>self</code><a class="anchor" aria-label="anchor" href="#using-self"></a>
</h2>
<p>One important difference between non-portable and portable classes is
that with non-portable classes, it’s possible to access members with
just the name of the member, and with portable classes, member access
always requires using <code>self$</code> or <code>private$</code>. This
is a consequence of the inheritance implementation.</p>
<p>Here’s an example of a non-portable class with two methods:
<code>sety</code>, which sets the private field <code>y</code> using the
<code>&lt;&lt;-</code> operator, and <code>getxy</code>, which returns a
vector with the values of fields <code>x</code> and <code>y</code>:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NP</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"NP"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    getxy <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>    sety <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;&lt;-</span> <span class="va">value</span></span>
<span>  <span class="op">)</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">np</span> <span class="op">&lt;-</span> <span class="va">NP</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">np</span><span class="op">$</span><span class="fu">sety</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">np</span><span class="op">$</span><span class="fu">getxy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1 20</span></span></code></pre></div>
<p>If we attempt the same with a portable class, it results in an
error:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">P</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"P"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    getxy <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>,</span>
<span>    sety <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="va">y</span> <span class="op">&lt;&lt;-</span> <span class="va">value</span></span>
<span>  <span class="op">)</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="va">P</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># No error, but instead of setting private$y, this sets y in the global</span></span>
<span><span class="co"># environment! This is because of the semantics of &lt;&lt;-.</span></span>
<span><span class="va">p</span><span class="op">$</span><span class="fu">sety</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">y</span></span>
<span><span class="co">#&gt; [1] 20</span></span>
<span></span>
<span><span class="va">p</span><span class="op">$</span><span class="fu">getxy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in p$getxy() : object 'y' not found</span></span></code></pre></div>
<p>To make this work with a portable class, we need to use
<code>self$x</code> and <code>private$y</code>:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">P2</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"P2"</span>,</span>
<span>  portable <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="fl">1</span>,</span>
<span>    getxy <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">self</span><span class="op">$</span><span class="va">x</span>, <span class="va">private</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>    sety <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">value</span><span class="op">)</span> <span class="va">private</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">value</span></span>
<span>  <span class="op">)</span>,</span>
<span>  private <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="cn">NA</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">P2</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">$</span><span class="fu">sety</span><span class="op">(</span><span class="fl">20</span><span class="op">)</span></span>
<span><span class="va">p2</span><span class="op">$</span><span class="fu">getxy</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  1 20</span></span></code></pre></div>
<p>There is a small performance penalty for using <code>self$x</code> as
opposed to <code>x</code>. In most cases, this is negligible, but it can
be noticeable in some situations where there are tens of thousands or
more accesses per second. For more information, see
<code><a href="../articles/Performance.html">vignette("Performance")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="potential-pitfalls-with-cross-package-inheritance">Potential pitfalls with cross-package inheritance<a class="anchor" aria-label="anchor" href="#potential-pitfalls-with-cross-package-inheritance"></a>
</h2>
<p>Inheritance happens when an object is instantiated with
<code>MyClass$new()</code>. At that time, members from the superclass
get copied to the new object. This means that when you instantiate R6
object, it will essentially save some pieces of the superclass in the
object.</p>
<p>Because of the way that packages are built in R, R6’s inheritance
behavior could potentially lead to surprising, hard-to-diagnose problems
when packages change versions.</p>
<p>Suppose you have two packages, pkgA, containing <code>ClassA</code>,
and pkgB, containing <code>ClassB</code>, and there is code in pkgB that
instantiates <code>ClassB</code> in an object, <code>objB</code>, at
build time. This is in contrast to instantiating <code>ClassB</code> at
run-time, by calling a function. All the code in the package is run when
a <em>binary</em> package is built, and the resulting objects are saved
in the package. (Generally, if the object can be accessed with
<code>pkgB:::objB</code>, this means it was created at build time.)</p>
<p>When <code>objB</code> is created at package build time, pieces from
the superclass, <code>pkgA::ClassA</code>, are saved inside it. This is
fine in and of itself. But imagine that pkgB was built and installed
against pkgA 1.0, and then you upgrade to pkgA 2.0 without subsequently
building and installing pkgB. Then <code>pkgB::objB</code> will contain
some code from <code>pkgA::ClassA</code> 1.0, but the version of
<code>pkgA::ClassA</code> that’s installed will be 2.0. This can cause
problems if <code>objB</code> inherited code which uses parts of
<code>pkgA</code> that have changed – but the problems may not be
entirely obvious.</p>
<p>This scenario is entirely possible when installing packages from
CRAN. It is very common for a package to be upgraded without upgrading
all of its downstream dependencies. As far as I know, R does not have
any mechanism to force downstream dependencies to be rebuilt when a
package is upgraded on a user’s computer.</p>
<p>If this problem happens, the remedy is to rebuild pkgB against pkgA
2.0. I don’t know if CRAN rebuilds all downstream dependencies when a
package is updated. If it doesn’t, then it’s possible for CRAN to have
incompatible binary builds of pkgA and pkgB, and users would then have
to install pkgB from source, with
<code>install.packages("pkgB", type = "source")</code>.</p>
<p>To avoid this problem entirely, objects of <code>ClassB</code> must
not be instantiated at build time. You can either (A) instantiate them
only in functions, or (B) instantiate them at package load time, by
adding an <code>.onLoad</code> function to your package. For
example:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ClassB</span> <span class="op">&lt;-</span> <span class="kw"><a href="../reference/R6Class.html">R6Class</a></span><span class="op">(</span><span class="st">"ClassB"</span>,</span>
<span>  inherit <span class="op">=</span> <span class="fu">pkgA</span><span class="fu">::</span><span class="va">ClassA</span>,</span>
<span>  public <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># We'll fill this at load time</span></span>
<span><span class="va">objB</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span></span>
<span><span class="va">.onLoad</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">libname</span>, <span class="va">pkgname</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># The namespace is locked after loading; we can still modify objB at this time.</span></span>
<span>  <span class="va">objB</span> <span class="op">&lt;&lt;-</span> <span class="va">ClassB</span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>You might be wondering why <code>ClassB</code> (the class, not the
instance of the class <code>objB</code>) doesn’t save a copy of
<code>pkgA::ClassA</code> inside of it when the package is built. This
is because, for the <code>inherit</code> argument, <code>R6Class</code>
saves the unevaluated expression (<code>pkgA::ClassA</code>), and
evaluates it when <code>$new()</code> is called.</p>
</div>
<div class="section level2">
<h2 id="wrap-up">Wrap-up<a class="anchor" aria-label="anchor" href="#wrap-up"></a>
</h2>
<p>In summary:</p>
<ul>
<li>Portable classes allow inheritance across different packages.</li>
<li>Portable classes always require the use of <code>self</code> or
<code>private</code> to access members. This can incur a small
performance penalty, since using <code>self$x</code> is slower than just
<code>x</code>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/wch" class="external-link">Winston Chang</a>, <a href="https://www.rstudio.com" class="external-link"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

  </div></footer>
</body>
</html>
